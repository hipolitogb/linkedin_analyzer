<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LinkedIn Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        .loader { border: 3px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin .8s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tag { display: inline-block; padding: 2px 10px; margin: 2px; border-radius: 9999px; font-size: 0.75rem; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

<!-- Navbar -->
<nav class="bg-gray-900 border-b border-gray-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <span class="text-xl font-bold text-blue-400">LinkedIn Analyzer</span>
            <span class="text-sm text-gray-400" id="nav-user-name"></span>
        </div>
        <div class="flex items-center gap-3">
            <a href="/register" class="text-sm text-gray-300 hover:text-white transition">Nueva extracción</a>
            <button onclick="logout()" class="text-sm text-gray-400 hover:text-red-400 transition">Cerrar sesión</button>
        </div>
    </div>
</nav>

<div class="max-w-7xl mx-auto px-4 py-8">

    <!-- Date Filter + Controls -->
    <div class="bg-gray-900 rounded-xl p-5 mb-8 border border-gray-800">
        <div class="flex flex-wrap items-end gap-4">
            <div>
                <label class="block text-xs text-gray-400 mb-1">Desde</label>
                <input id="filter-from" type="date" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">Hasta</label>
                <input id="filter-to" type="date" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
            </div>
            <button onclick="loadMetrics()" class="bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded-lg text-sm font-medium transition">
                Aplicar
            </button>
            <button id="btn-ai-analyze" onclick="runAIAnalysis()" class="bg-purple-600 hover:bg-purple-700 px-5 py-2 rounded-lg text-sm font-medium transition">
                Analizar con IA
            </button>
        </div>
        <div id="filter-status" class="text-sm text-gray-400 mt-2"></div>
        <div id="analysis-progress" class="hidden mt-3">
            <div class="flex items-center gap-3 text-sm text-gray-400">
                <span class="loader"></span>
                <span id="progress-text">Analizando...</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-2 mt-2">
                <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div id="summary-cards" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
            <p class="text-gray-400 text-xs uppercase tracking-wide">Total Posts</p>
            <p id="stat-total" class="text-2xl font-bold mt-1">0</p>
            <p id="stat-reposts" class="text-xs text-gray-500 mt-1 hidden"></p>
        </div>
        <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
            <p class="text-gray-400 text-xs uppercase tracking-wide">Total Reactions</p>
            <p id="stat-reactions" class="text-2xl font-bold mt-1">0</p>
        </div>
        <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
            <p class="text-gray-400 text-xs uppercase tracking-wide">Total Comments</p>
            <p id="stat-comments" class="text-2xl font-bold mt-1">0</p>
        </div>
        <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
            <p class="text-gray-400 text-xs uppercase tracking-wide">Avg Engagement</p>
            <p id="stat-avg-eng" class="text-2xl font-bold mt-1">0</p>
        </div>
    </div>

    <!-- Strategic Cards -->
    <div id="strategic-cards" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="rounded-xl p-5 border border-blue-700/40 bg-gradient-to-br from-blue-900/60 to-blue-800/30">
            <p class="text-blue-300 text-xs uppercase tracking-wide font-semibold mb-2">Alcance</p>
            <p class="text-2xl font-bold text-white" id="card-alcance-impressions">0</p>
            <p class="text-xs text-blue-300/70 mt-1">Total Impressions</p>
            <div class="mt-3 pt-3 border-t border-blue-700/30">
                <p class="text-sm text-blue-200"><span id="card-alcance-eng" class="font-semibold text-white">0</span> avg eng (non-link posts)</p>
            </div>
        </div>
        <div class="rounded-xl p-5 border border-emerald-700/40 bg-gradient-to-br from-emerald-900/60 to-emerald-800/30">
            <p class="text-emerald-300 text-xs uppercase tracking-wide font-semibold mb-2">Negocio</p>
            <p class="text-2xl font-bold text-white" id="card-negocio-ratio">0</p>
            <p class="text-xs text-emerald-300/70 mt-1">Conversation Ratio (link posts)</p>
            <div class="mt-3 pt-3 border-t border-emerald-700/30">
                <p class="text-sm text-emerald-200"><span id="card-negocio-count" class="font-semibold text-white">0</span> conversion posts</p>
            </div>
        </div>
        <div class="rounded-xl p-5 border border-purple-700/40 bg-gradient-to-br from-purple-900/60 to-purple-800/30">
            <p class="text-purple-300 text-xs uppercase tracking-wide font-semibold mb-2">Autoridad</p>
            <p class="text-lg font-bold text-white" id="card-autoridad-topic">&mdash;</p>
            <p class="text-xs text-purple-300/70 mt-1">Best Topic &middot; <span id="card-autoridad-eng">0</span> median eng</p>
            <div class="mt-3 pt-3 border-t border-purple-700/30">
                <p class="text-sm text-purple-200"><span id="card-autoridad-tl" class="font-semibold text-white">0%</span> thought leadership</p>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div id="charts-section" class="hidden">
        <!-- Funnel Analysis -->
        <div id="funnel-section" class="hidden mb-6">
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-4">Funnel Analysis &mdash; Awareness vs Conversion</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div><canvas id="chart-funnel"></canvas></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-gray-400 border-b border-gray-800">
                                    <th class="text-left py-2 pr-4">Stage</th>
                                    <th class="text-right py-2 pr-4">Posts</th>
                                    <th class="text-right py-2 pr-4">Median Eng</th>
                                    <th class="text-right py-2 pr-4">Conv. Ratio</th>
                                    <th class="text-right py-2">Avg Impressions</th>
                                </tr>
                            </thead>
                            <tbody id="funnel-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800 lg:col-span-2">
                <h3 class="text-sm font-medium text-gray-300 mb-3">Posts, Engagement e Impresiones por Mes</h3>
                <canvas id="chart-month"></canvas>
            </div>
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-1">Best Day to Post</h3>
                <p id="insight-day" class="text-xs text-emerald-400/70 mb-3 hidden"></p>
                <canvas id="chart-day"></canvas>
            </div>
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-1">Best Hour to Post</h3>
                <p id="insight-hour" class="text-xs text-emerald-400/70 mb-3 hidden"></p>
                <canvas id="chart-hour"></canvas>
            </div>
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-3">Content Type Distribution</h3>
                <canvas id="chart-content-type"></canvas>
            </div>
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-1">Avg Engagement by Content Type</h3>
                <p id="insight-eng-type" class="text-xs text-emerald-400/70 mb-3 hidden"></p>
                <canvas id="chart-eng-type"></canvas>
            </div>
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-3">Image vs No Image (Avg Engagement)</h3>
                <canvas id="chart-image-eng"></canvas>
            </div>
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-1">Post Length vs Engagement</h3>
                <p id="insight-length" class="text-xs text-emerald-400/70 mb-3 hidden"></p>
                <canvas id="chart-scatter"></canvas>
            </div>
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-3">Post Categories</h3>
                <canvas id="chart-categories"></canvas>
            </div>
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-3">Sentiment Analysis</h3>
                <canvas id="chart-sentiment"></canvas>
            </div>
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-3">Image Type Distribution</h3>
                <canvas id="chart-image-type"></canvas>
            </div>
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-3">Post Length Distribution</h3>
                <canvas id="chart-length"></canvas>
            </div>
        </div>

        <!-- Day x Hour Heatmap -->
        <div id="heatmap-section" class="hidden mb-6">
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-4">Engagement Heatmap &mdash; Day x Hour</h3>
                <div class="overflow-x-auto">
                    <div id="heatmap-grid" style="display:grid; grid-template-columns: 50px repeat(24, 1fr); gap: 2px; font-size: 0.65rem;"></div>
                </div>
            </div>
        </div>

        <!-- Keywords -->
        <div id="keywords-section" class="bg-gray-900 rounded-xl p-5 border border-gray-800 mb-6 hidden">
            <h3 class="text-sm font-medium text-gray-300 mb-3">Top Keywords / Topics</h3>
            <div id="keywords-cloud" class="flex flex-wrap gap-1"></div>
        </div>

        <!-- Topic Matrix -->
        <div id="topic-matrix-section" class="hidden mb-6">
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
                <h3 class="text-sm font-medium text-gray-300 mb-4">Topic Performance Matrix</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div><canvas id="chart-topic-matrix"></canvas></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-gray-400 border-b border-gray-800">
                                    <th class="text-left py-2 pr-4">Topic</th>
                                    <th class="text-right py-2 pr-4">Posts</th>
                                    <th class="text-right py-2 pr-4">Median Eng</th>
                                    <th class="text-right py-2">Avg Impressions</th>
                                </tr>
                            </thead>
                            <tbody id="topic-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deep Pattern Analysis (findings-based) -->
        <div id="pattern-section" class="hidden mb-6 space-y-6">
            <!-- CTA when no AI analysis available -->
            <div id="pattern-cta" class="hidden">
                <div class="bg-gray-900/60 rounded-xl border border-gray-800 p-8 text-center">
                    <div class="text-3xl mb-3 opacity-70">&#x1F50D;</div>
                    <h3 class="text-lg font-semibold text-white mb-2">Analisis cualitativo disponible</h3>
                    <p class="text-gray-400 text-sm mb-4 max-w-md mx-auto">
                        Usa el boton <strong class="text-purple-400">"Analizar con IA"</strong> para obtener hallazgos contrarios, patrones ocultos y recomendaciones personalizadas basadas en tus datos.
                    </p>
                    <button onclick="document.getElementById('btn-ai-analyze').click()"
                        class="inline-flex items-center gap-2 px-5 py-2.5 bg-purple-600 hover:bg-purple-500 text-white text-sm font-medium rounded-lg transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        Analizar con IA
                    </button>
                </div>
            </div>
            <!-- Key Metrics (contradicting dashboard) -->
            <div id="key-metrics-section" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>

            <!-- Tabs: Hallazgos | Números reales | Fórmula -->
            <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                <div class="flex border-b border-gray-800">
                    <button onclick="setAnalysisTab('findings')" id="tab-findings" class="flex-1 py-3 px-4 text-sm font-medium text-white bg-gray-800 transition">Hallazgos</button>
                    <button onclick="setAnalysisTab('reality')" id="tab-reality" class="flex-1 py-3 px-4 text-sm font-medium text-gray-400 hover:text-white transition">N&uacute;meros reales</button>
                    <button onclick="setAnalysisTab('formula')" id="tab-formula" class="flex-1 py-3 px-4 text-sm font-medium text-gray-400 hover:text-white transition">F&oacute;rmula &Oacute;ptima</button>
                </div>
                <div class="p-5">
                    <!-- Findings tab -->
                    <div id="panel-findings">
                        <div id="severity-badges" class="flex gap-2 mb-4"></div>
                        <div id="findings-list" class="space-y-3"></div>
                    </div>
                    <!-- Números reales tab -->
                    <div id="panel-reality" class="hidden space-y-6">
                        <div id="real-format-section" class="bg-gray-800/40 rounded-lg p-5 border border-gray-700/30"></div>
                        <div id="real-length-section" class="bg-gray-800/40 rounded-lg p-5 border border-gray-700/30"></div>
                        <div id="real-correlations-section" class="bg-gray-800/40 rounded-lg p-5 border border-gray-700/30"></div>
                        <div id="real-monthly-section" class="bg-gray-800/40 rounded-lg p-5 border border-gray-700/30"></div>
                    </div>
                    <!-- Formula tab -->
                    <div id="panel-formula" class="hidden space-y-4">
                        <div id="formula-card" class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-6 border border-gray-700"></div>
                        <div id="dashboard-vs-reality" class="space-y-3"></div>
                        <div id="top-actions" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Posts Table -->
        <div class="bg-gray-900 rounded-xl p-5 border border-gray-800 mb-8">
            <h3 class="text-sm font-medium text-gray-300 mb-3">Top Posts by Engagement</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 border-b border-gray-800">
                            <th class="text-left py-2 pr-4">#</th>
                            <th class="text-left py-2 pr-4">Date</th>
                            <th class="text-left py-2 pr-4">Type</th>
                            <th class="text-left py-2 pr-4 min-w-[300px]">Text</th>
                            <th class="text-right py-2 pr-4">Reactions</th>
                            <th class="text-right py-2 pr-4">Comments</th>
                            <th class="text-right py-2 pr-4">Impressions</th>
                            <th class="text-right py-2">Total</th>
                        </tr>
                    </thead>
                    <tbody id="posts-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Reposts Section -->
        <div id="reposts-section" class="hidden bg-gray-900 rounded-xl p-5 border border-yellow-800/40 mb-8">
            <div class="flex items-center gap-2 mb-3">
                <h3 class="text-sm font-medium text-yellow-400">Reposts</h3>
                <span id="reposts-count" class="text-xs bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 px-2 py-0.5 rounded-full">0</span>
                <span class="text-xs text-gray-500 ml-2">Excluidos de las metricas &mdash; datos del autor original</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 border-b border-gray-800">
                            <th class="text-left py-2 pr-4">Date</th>
                            <th class="text-left py-2 pr-4">Autor Original</th>
                            <th class="text-left py-2 pr-4 min-w-[300px]">Text</th>
                            <th class="text-right py-2 pr-4">Reactions</th>
                            <th class="text-right py-2 pr-4">Comments</th>
                            <th class="text-right py-2">Engagement</th>
                        </tr>
                    </thead>
                    <tbody id="reposts-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Drill-down Modal -->
<div id="drilldown-modal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-start justify-center pt-12 overflow-y-auto">
    <div class="bg-gray-900 rounded-xl border border-gray-700 w-full max-w-5xl mx-4 mb-12">
        <div class="flex items-center justify-between p-5 border-b border-gray-800">
            <h3 id="drilldown-title" class="text-lg font-semibold text-gray-200"></h3>
            <button onclick="closeDrilldown()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-5 overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-gray-400 border-b border-gray-800">
                        <th class="text-left py-2 pr-4">#</th>
                        <th class="text-left py-2 pr-4">Date</th>
                        <th class="text-left py-2 pr-4">Type</th>
                        <th class="text-left py-2 pr-4 min-w-[250px]">Text</th>
                        <th class="text-right py-2 pr-4">Reactions</th>
                        <th class="text-right py-2 pr-4">Comments</th>
                        <th class="text-right py-2 pr-4">Engagement</th>
                        <th class="text-right py-2 pr-4 cursor-pointer hover:text-emerald-400" onclick="toggleDrilldownSort()" id="drilldown-imp-header">Impressions &#x25BC;</th>
                    </tr>
                </thead>
                <tbody id="drilldown-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// ══════════════════════════════════════════════════════
// Auth & Data Loading (new for multi-tenant)
// ══════════════════════════════════════════════════════

function setFilterStatus(msg, loading = false) {
    document.getElementById('filter-status').innerHTML = loading ? `<span class="loader"></span> ${msg}` : msg;
}

async function loadUserInfo() {
    try {
        const res = await fetch('/api/auth/me');
        const data = await res.json();
        if (data.status === 'ok') {
            document.getElementById('nav-user-name').textContent =
                `${data.user.first_name} ${data.user.last_name}`;
        } else {
            window.location.href = '/login';
        }
    } catch (e) {
        window.location.href = '/login';
    }
}

async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    window.location.href = '/';
}

async function loadMetrics() {
    const fromDate = document.getElementById('filter-from').value;
    const toDate = document.getElementById('filter-to').value;
    setFilterStatus('Calculando métricas...', true);

    try {
        const res = await fetch('/api/dashboard/metrics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ from_date: fromDate || null, to_date: toDate || null })
        });
        const data = await res.json();
        if (data.status === 'ok') {
            setFilterStatus('');
            renderDashboard(data.metrics);
        } else {
            setFilterStatus(data.message || 'No hay datos para este rango.');
        }
    } catch (e) {
        setFilterStatus(`Error: ${e.message}`);
    }
}

async function runAIAnalysis() {
    const fromDate = document.getElementById('filter-from').value;
    const toDate = document.getElementById('filter-to').value;

    document.getElementById('btn-ai-analyze').disabled = true;
    document.getElementById('analysis-progress').classList.remove('hidden');
    document.getElementById('progress-text').textContent = 'Iniciando análisis con IA...';
    document.getElementById('progress-bar').style.width = '0%';
    setFilterStatus('');

    try {
        const res = await fetch('/api/dashboard/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ from_date: fromDate || null, to_date: toDate || null })
        });

        const contentType = res.headers.get('content-type') || '';

        if (contentType.includes('text/event-stream')) {
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let finalMetrics = null;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });

                const lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;
                    const payload = line.slice(6).trim();
                    if (payload === '[DONE]') continue;
                    try {
                        const msg = JSON.parse(payload);
                        if (msg.heartbeat) continue;
                        if (msg.phase) {
                            document.getElementById('progress-text').textContent = msg.message;
                            if (msg.phase === 'patterns') {
                                document.getElementById('progress-bar').style.width = '100%';
                            }
                        }
                        if (msg.current && msg.total) {
                            const pct = Math.round((msg.current / msg.total) * 100);
                            document.getElementById('progress-bar').style.width = pct + '%';
                            document.getElementById('progress-text').textContent =
                                `Clasificando post ${msg.current}/${msg.total}${msg.cached ? ' (cached)' : ''}...`;
                        }
                        if (msg.status === 'error' && msg.message) {
                            finalMetrics = null;
                            document.getElementById('analysis-progress').classList.add('hidden');
                            setFilterStatus(`Error en análisis: ${msg.message}`);
                            console.error('SSE analysis error:', msg.message);
                        }
                        if (msg.status === 'ok' && msg.metrics) {
                            finalMetrics = msg.metrics;
                        }
                    } catch (e) { /* skip */ }
                }
            }

            document.getElementById('analysis-progress').classList.add('hidden');
            if (finalMetrics) {
                renderDashboard(finalMetrics);
            } else {
                setFilterStatus('Análisis completado pero sin resultados.');
            }
        } else {
            const data = await res.json();
            document.getElementById('analysis-progress').classList.add('hidden');
            if (data.status === 'ok') {
                renderDashboard(data.metrics);
                if (data.cached) setFilterStatus('Resultados desde caché.');
            } else {
                setFilterStatus(data.message || 'Error en análisis.');
            }
        }
    } catch (e) {
        document.getElementById('analysis-progress').classList.add('hidden');
        setFilterStatus(`Error: ${e.message}`);
    }

    document.getElementById('btn-ai-analyze').disabled = false;
}

document.addEventListener('DOMContentLoaded', async () => {
    loadUserInfo();

    // Auto-detect date range from ALL scrape sessions
    try {
        const res = await fetch('/api/dashboard/date-range');
        const data = await res.json();
        if (data.status === 'ok' && data.min_date && data.max_date) {
            document.getElementById('filter-from').value = data.min_date;
            document.getElementById('filter-to').value = data.max_date;

            // Show scrape session info
            if (data.scrape_sessions && data.scrape_sessions.length > 0) {
                const sessions = data.scrape_sessions;
                const info = sessions.length === 1
                    ? `${data.total_posts} posts (${data.min_date} a ${data.max_date})`
                    : `${data.total_posts} posts de ${sessions.length} extracciones (${data.min_date} a ${data.max_date})`;
                setFilterStatus(info);
            }
        } else {
            // Fallback: 12 months ago to today
            const today = new Date();
            const fromDate = new Date(today);
            fromDate.setFullYear(fromDate.getFullYear() - 1);
            document.getElementById('filter-to').value = today.toISOString().slice(0, 10);
            document.getElementById('filter-from').value = fromDate.toISOString().slice(0, 10);
        }
    } catch (e) {
        // Fallback: 12 months ago to today
        const today = new Date();
        const fromDate = new Date(today);
        fromDate.setFullYear(fromDate.getFullYear() - 1);
        document.getElementById('filter-to').value = today.toISOString().slice(0, 10);
        document.getElementById('filter-from').value = fromDate.toISOString().slice(0, 10);
    }

    // Auto-load metrics
    loadMetrics();
});

// ══════════════════════════════════════════════════════
// Chart rendering (preserved verbatim from original dashboard)
// ══════════════════════════════════════════════════════

const COLORS = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316','#84cc16','#6366f1'];
const chartDefaults = {
    responsive: true,
    plugins: { legend: { labels: { color: '#9ca3af', font: { size: 11 } } } },
    scales: {
        x: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: '#1f2937' } },
        y: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: '#1f2937' } }
    }
};
const pieDefaults = {
    responsive: true,
    plugins: { legend: { position: 'right', labels: { color: '#9ca3af', font: { size: 11 }, padding: 12 } } }
};
let charts = {};

function destroyCharts() { Object.values(charts).forEach(c => c.destroy()); charts = {}; }

function renderDashboard(m) {
    destroyCharts();

    // Summary
    document.getElementById('summary-cards').classList.remove('hidden');
    document.getElementById('stat-total').textContent = m.total_posts;
    const repostsEl = document.getElementById('stat-reposts');
    if (m.total_reposts > 0) {
        repostsEl.textContent = `${m.total_reposts} repost${m.total_reposts > 1 ? 's' : ''} excluido${m.total_reposts > 1 ? 's' : ''}`;
        repostsEl.classList.remove('hidden');
    } else {
        repostsEl.classList.add('hidden');
    }
    document.getElementById('stat-reactions').textContent = (m.total_reactions || 0).toLocaleString();
    document.getElementById('stat-comments').textContent = (m.total_comments || 0).toLocaleString();
    document.getElementById('stat-avg-eng').textContent = m.avg_engagement || 0;

    document.getElementById('charts-section').classList.remove('hidden');

    // Combined monthly chart
    {
        const monthDatasets = [
            { label: 'Posts', data: m.posts_by_month.values, backgroundColor: 'rgba(59,130,246,0.7)', borderColor: '#3b82f6', borderWidth: 1, type: 'bar', yAxisID: 'y', order: 2 }
        ];
        const monthScales = {
            x: { ...chartDefaults.scales.x },
            y: {
                position: 'left',
                title: { display: true, text: 'Posts', color: '#3b82f6' },
                ticks: { color: '#3b82f6', font: { size: 10 }, stepSize: 1 },
                grid: { color: '#1f2937' },
                beginAtZero: true,
            },
        };
        if (m.engagement_evolution) {
            monthDatasets.push({
                label: 'Avg Engagement', data: m.engagement_evolution.values,
                borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)',
                type: 'line', fill: false, tension: 0.3, yAxisID: 'y1', order: 1, pointRadius: 3
            });
            monthScales.y1 = {
                position: 'right',
                title: { display: true, text: 'Avg Engagement', color: '#f59e0b' },
                ticks: { color: '#f59e0b', font: { size: 10 } },
                grid: { drawOnChartArea: false },
                beginAtZero: true,
            };
            if (m.engagement_evolution.impressions && m.engagement_evolution.impressions.some(v => v > 0)) {
                monthDatasets.push({
                    label: 'Avg Impressions', data: m.engagement_evolution.impressions,
                    borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)',
                    type: 'line', fill: false, tension: 0.3, yAxisID: 'y2', order: 0, pointRadius: 3, borderDash: [5, 3]
                });
                monthScales.y2 = {
                    position: 'right',
                    title: { display: true, text: 'Avg Impressions', color: '#10b981' },
                    ticks: { color: '#10b981', font: { size: 10 } },
                    grid: { drawOnChartArea: false },
                    beginAtZero: true,
                };
            }
        }
        charts.month = new Chart(document.getElementById('chart-month'), {
            type: 'bar',
            data: { labels: m.posts_by_month.labels, datasets: monthDatasets },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#9ca3af', font: { size: 11 } } } },
                scales: monthScales,
                interaction: { mode: 'index', intersect: false },
            }
        });
    }

    // Best day
    charts.day = new Chart(document.getElementById('chart-day'), {
        type: 'bar',
        data: {
            labels: m.posts_by_day.labels,
            datasets: [
                { label: 'Posts', data: m.posts_by_day.values, backgroundColor: '#8b5cf6' },
                ...(m.posts_by_day.avg_engagement ? [{ label: 'Avg Engagement', data: m.posts_by_day.avg_engagement, backgroundColor: '#f59e0b', yAxisID: 'y1' }] : [])
            ]
        },
        options: { ...chartDefaults, scales: { ...chartDefaults.scales, y1: { position: 'right', ticks: { color: '#6b7280' }, grid: { display: false } } } }
    });

    // Best hour
    charts.hour = new Chart(document.getElementById('chart-hour'), {
        type: 'bar',
        data: {
            labels: m.posts_by_hour.labels.map(h => `${h}:00`),
            datasets: [
                { label: 'Posts', data: m.posts_by_hour.values, backgroundColor: '#06b6d4' },
                ...(m.posts_by_hour.avg_engagement ? [{ label: 'Avg Engagement', data: m.posts_by_hour.avg_engagement, backgroundColor: '#f97316', yAxisID: 'y1' }] : [])
            ]
        },
        options: { ...chartDefaults, scales: { ...chartDefaults.scales, y1: { position: 'right', ticks: { color: '#6b7280' }, grid: { display: false } } } }
    });

    // Content type
    charts.contentType = new Chart(document.getElementById('chart-content-type'), {
        type: 'doughnut',
        data: { labels: m.content_types.labels, datasets: [{ data: m.content_types.values, backgroundColor: COLORS }] },
        options: pieDefaults
    });

    // Engagement by type
    if (m.engagement_by_type) {
        charts.engType = new Chart(document.getElementById('chart-eng-type'), {
            type: 'bar',
            data: { labels: m.engagement_by_type.labels, datasets: [{ label: 'Avg Engagement', data: m.engagement_by_type.values, backgroundColor: COLORS }] },
            options: chartDefaults
        });
    }

    // Image vs no image
    if (m.image_engagement) {
        charts.imageEng = new Chart(document.getElementById('chart-image-eng'), {
            type: 'bar',
            data: {
                labels: m.image_engagement.labels.map((l, i) => `${l} (${m.image_engagement.counts[i]})`),
                datasets: [{ label: 'Avg Engagement', data: m.image_engagement.values, backgroundColor: ['#3b82f6', '#6b7280'] }]
            },
            options: chartDefaults
        });
    }

    // Scatter: length vs engagement
    if (m.length_vs_engagement) {
        charts.scatter = new Chart(document.getElementById('chart-scatter'), {
            type: 'scatter',
            data: { datasets: [{ label: 'Posts', data: m.length_vs_engagement, backgroundColor: 'rgba(59,130,246,0.5)', pointRadius: 4 }] },
            options: { ...chartDefaults, scales: {
                x: { ...chartDefaults.scales.x, title: { display: true, text: 'Text Length (chars)', color: '#9ca3af' } },
                y: { ...chartDefaults.scales.y, title: { display: true, text: 'Engagement', color: '#9ca3af' } }
            }}
        });
    }

    // Categories
    if (m.categories && m.categories.labels.length > 0 && !(m.categories.labels.length === 1 && m.categories.labels[0] === 'other')) {
        charts.categories = new Chart(document.getElementById('chart-categories'), {
            type: 'doughnut',
            data: { labels: m.categories.labels, datasets: [{ data: m.categories.values, backgroundColor: COLORS }] },
            options: pieDefaults
        });
    }

    // Sentiment
    const sentimentColors = { positive: '#10b981', neutral: '#6b7280', negative: '#ef4444', inspirational: '#8b5cf6', controversial: '#f59e0b' };
    if (m.sentiments && m.sentiments.labels.length > 0 && !(m.sentiments.labels.length === 1 && m.sentiments.labels[0] === 'neutral')) {
        charts.sentiment = new Chart(document.getElementById('chart-sentiment'), {
            type: 'doughnut',
            data: { labels: m.sentiments.labels, datasets: [{ data: m.sentiments.values, backgroundColor: m.sentiments.labels.map(l => sentimentColors[l] || '#6b7280') }] },
            options: pieDefaults
        });
    }

    // Image type
    if (m.image_types && m.image_types.labels.length > 0) {
        charts.imageType = new Chart(document.getElementById('chart-image-type'), {
            type: 'doughnut',
            data: { labels: m.image_types.labels, datasets: [{ data: m.image_types.values, backgroundColor: COLORS }] },
            options: pieDefaults
        });
    }

    // Length buckets
    if (m.length_buckets) {
        charts.length = new Chart(document.getElementById('chart-length'), {
            type: 'bar',
            data: { labels: m.length_buckets.labels, datasets: [{ label: 'Posts', data: m.length_buckets.values, backgroundColor: '#f59e0b' }] },
            options: chartDefaults
        });
    }

    // Keywords
    const kwContainer = document.getElementById('keywords-cloud');
    kwContainer.innerHTML = '';
    if (m.top_keywords && m.top_keywords.length > 0) {
        document.getElementById('keywords-section').classList.remove('hidden');
        const maxCount = Math.max(...m.top_keywords.map(k => k.count), 1);
        m.top_keywords.forEach((kw, i) => {
            const size = 0.7 + (kw.count / maxCount) * 0.8;
            const span = document.createElement('span');
            span.className = 'tag';
            span.style.fontSize = `${size}rem`;
            span.style.backgroundColor = COLORS[i % COLORS.length] + '22';
            span.style.color = COLORS[i % COLORS.length];
            span.style.border = `1px solid ${COLORS[i % COLORS.length]}44`;
            span.textContent = `${kw.text} (${kw.count})`;
            kwContainer.appendChild(span);
        });
    }

    // Strategic Cards
    if (m.strategic_cards) {
        document.getElementById('strategic-cards').classList.remove('hidden');
        const sc = m.strategic_cards;
        document.getElementById('card-alcance-impressions').textContent = (sc.alcance.total_impressions || 0).toLocaleString();
        document.getElementById('card-alcance-eng').textContent = sc.alcance.avg_engagement_no_link || 0;
        document.getElementById('card-negocio-ratio').textContent = sc.negocio.conversation_ratio || 0;
        document.getElementById('card-negocio-count').textContent = sc.negocio.conversion_count || 0;
        document.getElementById('card-autoridad-topic').textContent = sc.autoridad.best_topic || '\u2014';
        document.getElementById('card-autoridad-eng').textContent = sc.autoridad.best_topic_median_eng || 0;
        document.getElementById('card-autoridad-tl').textContent = (sc.autoridad.thought_leadership_share || 0) + '%';
    }

    // Funnel Analysis
    if (m.funnel_analysis) {
        document.getElementById('funnel-section').classList.remove('hidden');
        const fa = m.funnel_analysis;
        const stages = Object.keys(fa);
        const stageLabels = stages.map(s => s.charAt(0).toUpperCase() + s.slice(1));
        const stageColors = stages.map(s => s === 'awareness' ? '#3b82f6' : '#10b981');

        charts.funnel = new Chart(document.getElementById('chart-funnel'), {
            type: 'bar',
            data: {
                labels: stageLabels,
                datasets: [
                    { label: 'Posts', data: stages.map(s => fa[s].count), backgroundColor: stageColors.map(c => c + 'aa'), yAxisID: 'y' },
                    { label: 'Median Eng', data: stages.map(s => fa[s].median_engagement), backgroundColor: stageColors.map(c => c + '55'), borderColor: stageColors, borderWidth: 2, yAxisID: 'y1' }
                ]
            },
            options: { ...chartDefaults, scales: { ...chartDefaults.scales, y1: { position: 'right', ticks: { color: '#6b7280' }, grid: { display: false } } } }
        });

        const ftb = document.getElementById('funnel-table-body');
        ftb.innerHTML = '';
        stages.forEach(s => {
            const d = fa[s];
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-800/50';
            tr.innerHTML = `
                <td class="py-2 pr-4 font-medium ${s === 'awareness' ? 'text-blue-400' : 'text-emerald-400'}">${s.charAt(0).toUpperCase() + s.slice(1)}</td>
                <td class="py-2 pr-4 text-right">${d.count}</td>
                <td class="py-2 pr-4 text-right">${d.median_engagement}</td>
                <td class="py-2 pr-4 text-right">${d.conversation_ratio}</td>
                <td class="py-2 text-right">${(d.avg_impressions || 0).toLocaleString()}</td>
            `;
            ftb.appendChild(tr);
        });
    }

    // Day x Hour Heatmap
    if (m.day_hour_heatmap && m.day_hour_heatmap.data) {
        document.getElementById('heatmap-section').classList.remove('hidden');
        const hm = m.day_hour_heatmap;
        const grid = document.getElementById('heatmap-grid');
        grid.innerHTML = '';

        const corner = document.createElement('div');
        corner.style.cssText = 'display:flex;align-items:end;justify-content:center;color:#6b7280;padding:2px;';
        grid.appendChild(corner);
        for (let h = 0; h < 24; h++) {
            const cell = document.createElement('div');
            cell.style.cssText = 'text-align:center;color:#6b7280;padding:2px;';
            cell.textContent = h + ':00';
            grid.appendChild(cell);
        }

        const maxVal = hm.max_value || 1;
        hm.day_labels.forEach((dayLabel, wd) => {
            const label = document.createElement('div');
            label.style.cssText = 'display:flex;align-items:center;justify-content:end;color:#9ca3af;padding:2px 6px;font-weight:500;';
            label.textContent = dayLabel;
            grid.appendChild(label);
            for (let hr = 0; hr < 24; hr++) {
                const entry = hm.data.find(d => d.day === wd && d.hour === hr);
                const val = entry ? entry.value : 0;
                const intensity = maxVal > 0 ? val / maxVal : 0;
                const cell = document.createElement('div');
                const r = Math.round(31 + (16 - 31) * intensity);
                const g = Math.round(41 + (185 - 41) * intensity);
                const b = Math.round(55 + (129 - 55) * intensity);
                const alpha = 0.15 + intensity * 0.85;
                cell.style.cssText = `background:rgba(${r},${g},${b},${alpha});color:${intensity > 0.5 ? '#fff' : '#9ca3af'};text-align:center;padding:4px 2px;border-radius:3px;cursor:default;font-size:0.6rem;`;
                cell.textContent = val > 0 ? val : '';
                cell.title = `${dayLabel} ${hr}:00 \u2014 Avg Engagement: ${val}`;
                grid.appendChild(cell);
            }
        });
    }

    // Topic Matrix
    if (m.topic_matrix && m.topic_matrix.length > 0) {
        document.getElementById('topic-matrix-section').classList.remove('hidden');
        const tm = m.topic_matrix;
        const topicLabels = tm.map(t => t.topic);
        const topicEngs = tm.map(t => t.median_engagement);

        charts.topicMatrix = new Chart(document.getElementById('chart-topic-matrix'), {
            type: 'bar',
            data: {
                labels: topicLabels,
                datasets: [{ label: 'Median Engagement', data: topicEngs, backgroundColor: COLORS.slice(0, tm.length) }]
            },
            options: { ...chartDefaults, indexAxis: 'y', plugins: { legend: { display: false } } }
        });

        const ttb = document.getElementById('topic-table-body');
        ttb.innerHTML = '';
        tm.forEach((t, i) => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-800/50';
            tr.innerHTML = `
                <td class="py-2 pr-4"><span class="inline-block w-2 h-2 rounded-full mr-2" style="background:${COLORS[i % COLORS.length]}"></span>${t.topic}</td>
                <td class="py-2 pr-4 text-right">${t.count}</td>
                <td class="py-2 pr-4 text-right font-medium text-emerald-400">${t.median_engagement}</td>
                <td class="py-2 text-right">${(t.avg_impressions || 0).toLocaleString()}</td>
            `;
            ttb.appendChild(tr);
        });
    }

    // Setup drill-down click handlers
    setupDrilldownHandlers(m);

    // Deep Pattern Analysis
    renderPatternAnalysis(m.pattern_analysis);

    // Top posts table
    const tbody = document.getElementById('posts-body');
    tbody.innerHTML = '';
    (m.top_posts || []).forEach((p, i) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-800/50 hover:bg-gray-800/30';
        const catBadge = p.category ? `<span class="tag bg-purple-500/20 text-purple-400 border border-purple-500/30 text-xs">${p.category}</span>` : '';
        const textCell = p.url
            ? `<a href="${p.url}" target="_blank" rel="noopener" class="text-blue-400 hover:text-blue-300 hover:underline">${p.text}</a>`
            : p.text;
        tr.innerHTML = `
            <td class="py-2 pr-4 text-gray-400">${i + 1}</td>
            <td class="py-2 pr-4 whitespace-nowrap">${p.date}</td>
            <td class="py-2 pr-4"><span class="tag bg-blue-500/20 text-blue-400 border border-blue-500/30">${p.content_type}</span> ${catBadge}</td>
            <td class="py-2 pr-4 text-gray-300">${textCell}</td>
            <td class="py-2 pr-4 text-right">${p.reactions}</td>
            <td class="py-2 pr-4 text-right">${p.comments}</td>
            <td class="py-2 pr-4 text-right">${(p.impressions || 0).toLocaleString()}</td>
            <td class="py-2 text-right font-medium text-emerald-400">${p.engagement}</td>
        `;
        tbody.appendChild(tr);
    });

    // Reposts table
    const repostsList = (m.all_posts || []).filter(p => p.is_repost);
    const repostsSection = document.getElementById('reposts-section');
    if (repostsList.length > 0) {
        repostsSection.classList.remove('hidden');
        document.getElementById('reposts-count').textContent = repostsList.length;
        const rbody = document.getElementById('reposts-body');
        rbody.innerHTML = '';
        repostsList.sort((a, b) => b.engagement - a.engagement).forEach(p => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-800/50 hover:bg-yellow-900/10';
            const textCell = p.url
                ? `<a href="${p.url}" target="_blank" rel="noopener" class="text-blue-400 hover:text-blue-300 hover:underline">${p.text}</a>`
                : p.text;
            tr.innerHTML = `
                <td class="py-2 pr-4 whitespace-nowrap">${p.date}</td>
                <td class="py-2 pr-4 text-yellow-400">${p.original_author || 'Desconocido'}</td>
                <td class="py-2 pr-4 text-gray-300">${textCell}</td>
                <td class="py-2 pr-4 text-right">${p.reactions}</td>
                <td class="py-2 pr-4 text-right">${p.comments}</td>
                <td class="py-2 text-right font-medium text-gray-400">${p.engagement}</td>
            `;
            rbody.appendChild(tr);
        });
    } else {
        repostsSection.classList.add('hidden');
    }
}

let _currentAnalysisTab = 'findings';
let _openFindings = new Set();

function setAnalysisTab(tab) {
    _currentAnalysisTab = tab;
    ['findings', 'reality', 'formula'].forEach(t => {
        document.getElementById(`panel-${t}`).classList.toggle('hidden', t !== tab);
        const btn = document.getElementById(`tab-${t}`);
        btn.className = t === tab
            ? 'flex-1 py-3 px-4 text-sm font-medium text-white bg-gray-800 transition'
            : 'flex-1 py-3 px-4 text-sm font-medium text-gray-400 hover:text-white transition';
    });
}

function toggleFinding(id) {
    if (_openFindings.has(id)) _openFindings.delete(id);
    else _openFindings.add(id);
    const details = document.getElementById(`finding-details-${id}`);
    const icon = document.getElementById(`finding-icon-${id}`);
    if (details) details.classList.toggle('hidden');
    if (icon) icon.textContent = _openFindings.has(id) ? '\u2212' : '+';
}

function renderPatternAnalysis(pa) {
    const section = document.getElementById('pattern-section');
    const cta = document.getElementById('pattern-cta');

    if (!pa || pa.error) {
        // Show section with CTA instead of hiding silently
        section.classList.remove('hidden');
        cta.classList.remove('hidden');
        return;
    }

    // Support both new findings format and legacy format
    const hasFindings = pa.findings && pa.findings.length > 0;
    if (!hasFindings && !pa.executive_summary) {
        section.classList.remove('hidden');
        cta.classList.remove('hidden');
        return;
    }

    // Has real data — hide CTA, show analysis
    cta.classList.add('hidden');
    section.classList.remove('hidden');
    _openFindings = new Set();

    const severityConfig = {
        critical: { bg: 'bg-red-900/20', border: 'border-red-800/40', badge: 'bg-red-900/40 text-red-300', label: 'Critico' },
        warning: { bg: 'bg-amber-900/20', border: 'border-amber-800/40', badge: 'bg-amber-900/40 text-amber-300', label: 'Atencion' },
        insight: { bg: 'bg-blue-900/20', border: 'border-blue-800/40', badge: 'bg-blue-900/40 text-blue-300', label: 'Insight' },
    };

    // ── Key Metrics ──
    const metricsContainer = document.getElementById('key-metrics-section');
    metricsContainer.innerHTML = '';
    if (pa.key_metrics && pa.key_metrics.length > 0) {
        pa.key_metrics.forEach(m => {
            metricsContainer.innerHTML += `
                <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                    <p class="text-gray-400 text-xs uppercase tracking-wide">${m.label}</p>
                    <p class="text-2xl font-bold text-white mt-1">${m.value}</p>
                    <p class="text-xs text-gray-500 mt-1">${m.subtext}</p>
                </div>`;
        });
    }

    // ── Findings tab ──
    if (hasFindings) {
        // Severity badges
        const badgesContainer = document.getElementById('severity-badges');
        const counts = {};
        pa.findings.forEach(f => { counts[f.severity] = (counts[f.severity] || 0) + 1; });
        badgesContainer.innerHTML = Object.entries(counts).map(([sev, count]) => {
            const cfg = severityConfig[sev] || severityConfig.insight;
            return `<span class="text-xs px-3 py-1 rounded-full ${cfg.badge}">${cfg.label} (${count})</span>`;
        }).join('');

        // Findings list
        const findingsList = document.getElementById('findings-list');
        findingsList.innerHTML = '';
        pa.findings.forEach(f => {
            const cfg = severityConfig[f.severity] || severityConfig.insight;
            findingsList.innerHTML += `
                <div class="rounded-lg border ${cfg.border} ${cfg.bg} overflow-hidden">
                    <button onclick="toggleFinding('${f.id}')"
                        class="w-full text-left p-4 flex items-start gap-3 hover:bg-white/5 transition-colors">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-100 text-sm">${f.title}</div>
                            <div class="text-xs text-gray-400 mt-1">${f.summary}</div>
                        </div>
                        <span id="finding-icon-${f.id}" class="text-gray-400 text-lg shrink-0">+</span>
                    </button>
                    <div id="finding-details-${f.id}" class="hidden px-4 pb-4">
                        <div class="space-y-2 mb-3">
                            ${(f.details || []).map(d => `
                                <div class="text-xs text-gray-300 leading-relaxed flex gap-2">
                                    <span class="text-gray-500 shrink-0">&rarr;</span>
                                    <span>${d}</span>
                                </div>
                            `).join('')}
                        </div>
                        ${f.action ? `
                        <div class="bg-gray-800/60 rounded-md p-3 border border-gray-700/40">
                            <div class="text-xs font-semibold text-emerald-400 mb-1">Accion recomendada</div>
                            <div class="text-xs text-gray-300">${f.action}</div>
                        </div>` : ''}
                    </div>
                </div>`;
        });

        // Auto-open first finding
        if (pa.findings.length > 0) toggleFinding(pa.findings[0].id);
    }

    // ── Números reales tab ──
    _renderRealNumbers(pa._raw_stats);

    // ── Formula tab ──
    const formulaCard = document.getElementById('formula-card');
    const topActions = document.getElementById('top-actions');

    if (pa.optimal_formula) {
        const of = pa.optimal_formula;
        const fields = [
            { label: 'Formato', value: of.format },
            { label: 'Largo', value: of.length },
            { label: 'Menciones', value: of.mentions },
            { label: 'Links', value: of.links },
            { label: 'Contenido', value: of.content_style },
            { label: 'Hashtags', value: of.hashtags },
            { label: 'Cuando', value: of.when },
            { label: 'Reposts', value: of.repost_limit },
        ].filter(f => f.value);

        formulaCard.innerHTML = `
            <h3 class="text-lg font-bold text-white mb-4">Tu Post Optimo Real</h3>
            <p class="text-xs text-gray-400 mb-4">Basado en datos limpios (sin outliers, solo originales, con tests estadisticos)</p>
            <div class="space-y-3">
                ${fields.map(f => `
                    <div class="flex items-start gap-3">
                        <div>
                            <span class="text-xs text-gray-400">${f.label}:</span>
                            <span class="text-sm font-semibold text-white ml-2">${f.value}</span>
                        </div>
                    </div>
                `).join('')}
            </div>`;
    } else {
        formulaCard.innerHTML = '<p class="text-gray-500 text-sm">Formula no disponible.</p>';
    }

    // Top 3 actions
    topActions.innerHTML = '';
    if (pa.top_3_actions && pa.top_3_actions.length > 0) {
        topActions.innerHTML = `
            <div class="bg-blue-900/20 rounded-lg p-4 border border-blue-800/30">
                <h4 class="text-sm font-bold text-blue-300 mb-3">Top ${pa.top_3_actions.length} acciones con mayor impacto</h4>
                <div class="space-y-3">
                    ${pa.top_3_actions.map((a, i) => `
                        <div class="flex gap-2 text-xs text-gray-300">
                            <span class="text-blue-400 font-bold shrink-0">${i + 1}.</span>
                            <div>
                                <span class="font-semibold text-white">${a.action}</span>
                                <p class="text-gray-400 mt-0.5">${a.expected_impact}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
    }

    // ── Dashboard vs Reality (in formula tab) ──
    const dvrSection = document.getElementById('dashboard-vs-reality');
    if (dvrSection && pa.dashboard_vs_reality && pa.dashboard_vs_reality.length > 0) {
        dvrSection.innerHTML = `
            <div class="bg-amber-900/20 rounded-lg p-4 border border-amber-800/30">
                <h4 class="text-sm font-bold text-amber-300 mb-3">Lo que el dashboard dijo vs la realidad</h4>
                <div class="space-y-2 text-xs">
                    ${pa.dashboard_vs_reality.map(item => `
                        <div class="flex gap-2">
                            <span class="text-red-400 shrink-0">&times;</span>
                            <span class="text-gray-500 line-through">${item.dashboard_says}</span>
                            <span class="text-emerald-400">&rarr; ${item.reality}</span>
                        </div>
                    `).join('')}
                </div>
            </div>`;
    }

    // ── Chart card insights ──
    _renderChartInsights(pa._raw_stats);
}

// ── Comparison bar helper ──
function _comparisonBar(label, value, maxValue, color, annotation) {
    const width = maxValue > 0 ? Math.min((value / maxValue) * 100, 100) : 0;
    return '<div class="mb-2">' +
        '<div class="flex justify-between text-xs mb-1">' +
            '<span class="text-gray-400">' + label + '</span>' +
            '<span class="font-mono font-bold text-gray-200">' + value + '</span>' +
        '</div>' +
        '<div class="h-5 bg-gray-700/50 rounded-full overflow-hidden relative">' +
            '<div class="h-full ' + color + ' rounded-full transition-all duration-500" style="width: ' + width + '%"></div>' +
            (annotation ? '<span class="absolute right-2 top-0.5 text-[10px] text-gray-400">' + annotation + '</span>' : '') +
        '</div>' +
    '</div>';
}

// ── Números reales rendering ──
function _renderRealNumbers(rawStats) {
    if (!rawStats) return;

    // Format comparison (originals only, no outlier)
    const formatSection = document.getElementById('real-format-section');
    const fmtClean = rawStats.format_stats_clean;
    if (fmtClean && Object.keys(fmtClean).length > 0) {
        const maxVal = Math.max(...Object.values(fmtClean).map(f => f.mean || 0), 1);
        const colorMap = { image: 'bg-blue-500', video: 'bg-purple-500', carousel: 'bg-amber-500', text: 'bg-gray-500', article: 'bg-emerald-500' };
        const sorted = Object.entries(fmtClean).sort((a, b) => (b[1].mean || 0) - (a[1].mean || 0));
        const bestFormat = sorted[0] ? sorted[0][0] : '';
        formatSection.innerHTML =
            '<h3 class="text-sm font-bold text-gray-200 mb-3">Engagement por tipo (solo originales, sin outlier)</h3>' +
            sorted.map(function(entry) {
                return _comparisonBar(
                    entry[0] + ' (n=' + entry[1].n + ')', entry[1].mean, maxVal,
                    colorMap[entry[0]] || 'bg-gray-500',
                    entry[0] === bestFormat ? 'MVP' : ''
                );
            }).join('') +
            '<p class="text-xs text-gray-500 mt-2 italic">El dashboard incluye reposts + outliers &mdash; los n&uacute;meros pueden ser muy diferentes</p>';
    } else {
        formatSection.classList.add('hidden');
    }

    // Length buckets
    const lengthSection = document.getElementById('real-length-section');
    const lenBuckets = rawStats.length_buckets_clean;
    if (lenBuckets && Object.keys(lenBuckets).length > 0) {
        const maxLen = Math.max(...Object.values(lenBuckets).map(b => b.mean || 0), 1);
        const entries = Object.entries(lenBuckets);
        const bestBucket = entries.reduce(function(a, b) { return (b[1].mean || 0) > (a[1].mean || 0) ? b : a; });
        lengthSection.innerHTML =
            '<h3 class="text-sm font-bold text-gray-200 mb-3">Engagement por largo de texto (sin outlier)</h3>' +
            entries.map(function(entry) {
                return _comparisonBar(
                    entry[0] + ' chars (n=' + entry[1].n + ')', entry[1].mean, maxLen,
                    entry[1].mean >= maxLen * 0.8 ? 'bg-emerald-500' : entry[1].mean >= maxLen * 0.5 ? 'bg-blue-400' : 'bg-gray-500',
                    entry[0] === bestBucket[0] ? 'SWEET SPOT' : ''
                );
            }).join('');
    } else {
        lengthSection.classList.add('hidden');
    }

    // Correlations
    const corrSection = document.getElementById('real-correlations-section');
    const corrs = rawStats.correlations;
    if (corrs && corrs.filter(function(c) { return c.significant; }).length > 0) {
        const sigCorrs = corrs.filter(function(c) { return c.significant; });
        const featureLabels = {
            text_length: 'Largo de texto &rarr; Engagement',
            num_mentions: 'Menciones &rarr; Engagement',
            num_hashtags: 'Hashtags &rarr; Engagement',
            num_paragraphs: 'P&aacute;rrafos &rarr; Engagement',
            avg_paragraph_length: 'P&aacute;rrafo promedio &rarr; Eng',
            has_link: 'Tiene link &rarr; Engagement',
            has_emoji: 'Tiene emoji &rarr; Engagement',
            has_cta: 'Tiene CTA &rarr; Engagement',
            hour_posted: 'Hora publicaci&oacute;n &rarr; Engagement',
            day_of_week: 'D&iacute;a semana &rarr; Engagement',
        };
        corrSection.innerHTML =
            '<h3 class="text-sm font-bold text-gray-200 mb-3">Variables con correlaci&oacute;n significativa</h3>' +
            '<div class="space-y-2">' +
            sigCorrs.map(function(c) {
                var absRho = Math.abs(c.rho);
                var label = featureLabels[c.feature] || c.feature;
                return '<div class="flex items-center gap-3 text-xs">' +
                    '<div class="w-16 h-2 bg-gray-700/50 rounded-full overflow-hidden shrink-0">' +
                        '<div class="h-full ' + (c.rho > 0 ? 'bg-emerald-500' : 'bg-red-400') + ' rounded-full" style="width: ' + (absRho * 100) + '%"></div>' +
                    '</div>' +
                    '<span class="font-mono font-bold w-12 shrink-0 ' + (c.rho > 0 ? 'text-emerald-400' : 'text-red-400') + '">' + c.rho.toFixed(2) + '</span>' +
                    '<span class="text-gray-300 flex-1">' + label + '</span>' +
                    '<span class="text-gray-500 shrink-0">p=' + c.p_value + '</span>' +
                '</div>';
            }).join('') +
            '</div>';
    } else {
        corrSection.classList.add('hidden');
    }

    // Monthly trend
    const monthlySection = document.getElementById('real-monthly-section');
    const monthlyStats = rawStats.temporal ? rawStats.temporal.monthly_stats : null;
    if (monthlyStats && Object.keys(monthlyStats).length > 0) {
        const entries = Object.entries(monthlyStats);
        const maxMedian = Math.max(...entries.map(function(e) { return e[1].median || 0; }), 1);
        const monthNames = { '01': 'Ene', '02': 'Feb', '03': 'Mar', '04': 'Abr', '05': 'May', '06': 'Jun', '07': 'Jul', '08': 'Ago', '09': 'Sep', '10': 'Oct', '11': 'Nov', '12': 'Dic' };
        const tau = rawStats.temporal.kendall_tau;
        const dir = rawStats.temporal.direction;
        const trendInfo = tau !== undefined
            ? 'Kendall tau = ' + tau + ' (' + (dir === 'growing' ? 'tendencia positiva' : dir === 'declining' ? 'tendencia negativa' : 'sin tendencia clara') + ')'
            : '';
        const pctChange = rawStats.temporal.pct_change || 0;
        monthlySection.innerHTML =
            '<h3 class="text-sm font-bold text-gray-200 mb-3">Tendencia mensual (mediana de engagement)</h3>' +
            '<div class="flex items-end gap-1 h-32">' +
            entries.map(function(entry, idx) {
                var month = entry[0], data = entry[1];
                var monthLabel = monthNames[month.split('-')[1]] || month;
                var height = maxMedian > 0 ? (data.median / maxMedian) * 100 : 0;
                var isLast = idx === entries.length - 1;
                var color = isLast && pctChange < -30 ? 'bg-red-400' : data.median >= maxMedian * 0.7 ? 'bg-emerald-400' : 'bg-blue-400';
                return '<div class="flex-1 flex flex-col items-center gap-1">' +
                    '<span class="text-[10px] font-mono text-gray-500">' + data.median + '</span>' +
                    '<div class="w-full rounded-t ' + color + '" style="height: ' + height + '%"></div>' +
                    '<span class="text-[10px] text-gray-500">' + monthLabel + '</span>' +
                '</div>';
            }).join('') +
            '</div>' +
            (trendInfo ? '<p class="text-xs text-gray-500 mt-2 italic">' + trendInfo + '</p>' : '');
    } else {
        monthlySection.classList.add('hidden');
    }
}

// ── Chart card insights ──
function _renderChartInsights(rawStats) {
    if (!rawStats) return;

    // Day insight
    var dayInsight = document.getElementById('insight-day');
    if (dayInsight && rawStats.temporal) {
        if (rawStats.temporal.day_significant === false) {
            dayInsight.textContent = 'No hay diferencia significativa entre d\u00edas (Kruskal-Wallis p > 0.05) \u2014 public\u00e1 cualquier d\u00eda';
            dayInsight.classList.remove('hidden');
        } else if (rawStats.temporal.day_significant === true) {
            dayInsight.textContent = 'Diferencia significativa entre d\u00edas (p=' + rawStats.temporal.kruskal_wallis_p + ')';
            dayInsight.classList.remove('hidden');
        }
    }

    // Hour insight
    var hourInsight = document.getElementById('insight-hour');
    if (hourInsight && rawStats.correlations) {
        var hourCorr = rawStats.correlations.find(function(c) { return c.feature === 'hour_posted'; });
        if (hourCorr && !hourCorr.significant) {
            hourInsight.textContent = 'La hora de publicaci\u00f3n no correlaciona con engagement (p > 0.05)';
            hourInsight.classList.remove('hidden');
        } else if (hourCorr && hourCorr.significant) {
            hourInsight.textContent = 'Correlaci\u00f3n ' + (hourCorr.direction === 'positive' ? 'positiva' : 'negativa') + ' (rho=' + hourCorr.rho + ', p=' + hourCorr.p_value + ')';
            hourInsight.classList.remove('hidden');
        }
    }

    // Engagement by type insight
    var engTypeInsight = document.getElementById('insight-eng-type');
    if (engTypeInsight && rawStats.format_stats_clean) {
        var clean = rawStats.format_stats_clean;
        var all = rawStats.format_stats_all || {};
        var cleanEntries = Object.entries(clean).sort(function(a, b) { return (b[1].mean || 0) - (a[1].mean || 0); });
        var allEntries = Object.entries(all).sort(function(a, b) { return (b[1].mean || 0) - (a[1].mean || 0); });
        if (cleanEntries.length > 0 && allEntries.length > 0) {
            var bestClean = cleanEntries[0][0];
            var bestAll = allEntries[0][0];
            if (bestClean !== bestAll) {
                engTypeInsight.textContent = 'Sin outliers ni reposts, ' + bestClean + ' (avg ' + cleanEntries[0][1].mean + ') supera a ' + bestAll + ' \u2014 el dashboard muestra datos contaminados';
            } else {
                engTypeInsight.textContent = bestClean + ' es el mejor formato (avg ' + cleanEntries[0][1].mean + ' solo originales sin outlier)';
            }
            engTypeInsight.classList.remove('hidden');
        }
    }

    // Post length insight
    var lengthInsight = document.getElementById('insight-length');
    if (lengthInsight && rawStats.correlations) {
        var lenCorr = rawStats.correlations.find(function(c) { return c.feature === 'text_length'; });
        if (lenCorr && lenCorr.significant) {
            var dir = lenCorr.rho > 0 ? 'm\u00e1s largo = m\u00e1s engagement' : 'm\u00e1s corto = m\u00e1s engagement';
            lengthInsight.textContent = 'Correlaci\u00f3n ' + (lenCorr.rho > 0 ? 'positiva' : 'negativa') + ' (rho=' + lenCorr.rho + ', p=' + lenCorr.p_value + ') \u2014 ' + dir;
            lengthInsight.classList.remove('hidden');
        }
    }
}

// ── Drill-down ──
let _allPosts = [];
let _drilldownSortAsc = false;
let _drilldownFiltered = [];

function showDrilldown(title, posts) {
    _drilldownFiltered = posts;
    _drilldownSortAsc = false;
    document.getElementById('drilldown-title').textContent = title;
    document.getElementById('drilldown-imp-header').innerHTML = 'Impressions &#x25BC;';
    renderDrilldownTable(posts);
    document.getElementById('drilldown-modal').classList.remove('hidden');
}

function closeDrilldown() {
    document.getElementById('drilldown-modal').classList.add('hidden');
}

function toggleDrilldownSort() {
    _drilldownSortAsc = !_drilldownSortAsc;
    _drilldownFiltered.sort((a, b) => _drilldownSortAsc ? a.impressions - b.impressions : b.impressions - a.impressions);
    document.getElementById('drilldown-imp-header').innerHTML = _drilldownSortAsc ? 'Impressions &#x25B2;' : 'Impressions &#x25BC;';
    renderDrilldownTable(_drilldownFiltered);
}

function renderDrilldownTable(posts) {
    const tbody = document.getElementById('drilldown-body');
    tbody.innerHTML = '';
    posts.slice(0, 20).forEach((p, i) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-800/50 hover:bg-gray-800/30';
        const textCell = p.url
            ? `<a href="${p.url}" target="_blank" rel="noopener" class="text-blue-400 hover:text-blue-300 hover:underline">${p.text}</a>`
            : p.text;
        tr.innerHTML = `
            <td class="py-2 pr-4 text-gray-400">${i + 1}</td>
            <td class="py-2 pr-4 whitespace-nowrap">${p.date}</td>
            <td class="py-2 pr-4"><span class="tag bg-blue-500/20 text-blue-400 border border-blue-500/30">${p.content_type}</span></td>
            <td class="py-2 pr-4 text-gray-300">${textCell}</td>
            <td class="py-2 pr-4 text-right">${p.reactions}</td>
            <td class="py-2 pr-4 text-right">${p.comments}</td>
            <td class="py-2 pr-4 text-right">${p.engagement}</td>
            <td class="py-2 text-right font-medium text-emerald-400">${(p.impressions || 0).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
    });
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDrilldown(); });
document.getElementById('drilldown-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeDrilldown(); });

function addChartClickHandler(chart, filterFn, titleFn) {
    chart.options.onClick = (evt, elements) => {
        if (!elements.length || !_allPosts.length) return;
        const idx = elements[0].index;
        const label = chart.data.labels[idx];
        const filtered = _allPosts.filter(p => filterFn(p, label, idx));
        filtered.sort((a, b) => b.impressions - a.impressions);
        showDrilldown(titleFn(label, filtered.length), filtered);
    };
    chart.update();
}

function setupDrilldownHandlers(m) {
    _allPosts = m.all_posts || [];
    if (charts.day) addChartClickHandler(charts.day,
        (p, label) => p.day === label,
        (label, n) => `Posts on ${label} (${n} posts) \u2014 Top 20 by Impressions`
    );
    if (charts.contentType) addChartClickHandler(charts.contentType,
        (p, label) => p.content_type === label,
        (label, n) => `Content type: ${label} (${n} posts) \u2014 Top 20 by Impressions`
    );
    if (charts.imageEng) addChartClickHandler(charts.imageEng,
        (p, label) => label.startsWith('With') ? p.has_image : !p.has_image,
        (label, n) => `${label} (${n} posts) \u2014 Top 20 by Impressions`
    );
    if (charts.categories) addChartClickHandler(charts.categories,
        (p, label) => p.category === label,
        (label, n) => `Category: ${label} (${n} posts) \u2014 Top 20 by Impressions`
    );
    if (charts.sentiment) addChartClickHandler(charts.sentiment,
        (p, label) => p.sentiment === label,
        (label, n) => `Sentiment: ${label} (${n} posts) \u2014 Top 20 by Impressions`
    );
    if (charts.length) addChartClickHandler(charts.length,
        (p, label) => {
            const l = p.text_length;
            if (label === '0-100') return l < 100;
            if (label === '100-300') return l >= 100 && l < 300;
            if (label === '300-500') return l >= 300 && l < 500;
            if (label === '500-1000') return l >= 500 && l < 1000;
            if (label === '1000+') return l >= 1000;
            return false;
        },
        (label, n) => `Length ${label} chars (${n} posts) \u2014 Top 20 by Impressions`
    );
}
</script>
</body>
</html>
